
api_url = "<%= ENV['OPP_API_URL'] %>";
product_data = null;
decisions_data = null;


function fetch_product() {

	var ri_num_value = $('#ri_num').val();
	var url = api_url + ":3000/products/" + ri_num_value;
	//show div for spinner

	$.ajax({
	  type: "get",
	  url: url,
      crossDomain: true,
      beforeSend: function(xhr) {
      	$("#current_decision").css("display","block");
      	var el = $("#current_decision");//WRONG DIV - do decision!
		var spinner = el.qspin({task:'add',background: 'transparent', spinnerImage: 'Loading_icon.gif'});
      }
      ,
      success: function (data){
    	
    	product_data = data[0];
    	loadProduct();
      }

	});

};
	

  
function loadProduct() {

	var tempData = product_data;
	$("#product_header").css("display","block"); //show product header
	//load summary fields
	$('#ri_name').html(tempData.rin_name);
	$('#ri_number').html(tempData.ri_num);
	//$('#ri_type').html(tempData.rist_name);
	$('#co_name').html(tempData.co_name);
	$('#ri_status').html(tempData.rist_name);
 	
};

function fetch_decisions(){

	var ri_num_value = $('#ri_num').val();
	var url = api_url + ":3000/decisions/" + ri_num_value;

	$.ajax({
	  type: "get",
	  url: url,
      crossDomain: true,
      success: function (data){
    	
    	decisions_data = data;
    	loadDecisions();
      }

	});

}

function loadDecisions() {

	//$("#decision_history").empty();
	var tmpDecisions = decisions_data;

 	//setup current Decision
 	var tbl = $("#current_decision .decision_table");
 	setupDecision(tmpDecisions, "current", tbl);
 	//setup decision history
 	var tbl = $("#past_decisions .decision_table");
 	setupDecision(tmpDecisions, "past", tbl); 	

	
}

function setupDecision(tDecisions, filterText, tTbl){
	//sets up a whole decisions table for a particular filter, such as current

	$.each( tDecisions, function( index, decision ) {
		switch(filterText) {
	    case "current":
	    	if (decision.dstty_type == 'PENDING'){
 				$("#current_decision").css("display","inline-block");
 				buildTable();
	    	}

	        break;
	    case "past":
	    	if (decision.dstty_type != 'PENDING'){
 				$("#past_decisions").css("display","inline-block");
 				buildTable();
	    	}

	        break;	        
	    default:
	        return;
	    }

	    function buildTable(){
		    var detailPane = $("<tr><td colspan='8' class='detail_pane'><table class='receipt_table'></table></td></tr>");
		    //create a row for each decision 
		    var row = $("<tr></tr>");
		    $(row).attr("onclick","javascript: showDetail(this);");

		    var c1 = $("<td>" + decision.dec_seq + "</td>");
		    var c2 = $("<td>" + decision.adt_action_cd	 + "</td>");

		    var c3 = $("<td>" + decision.dstty_type + "</td>");
		    var c4 = $("<td>" + decision.org_division_name + "/" + decision.org_branch_name + "</td>");
		    var c5 = $("<td>" + "xxxxx" + "</td>");
		    var c6 = $("<td>" + oracleDate(decision.ffs_start_dt) + "</td>");
		    var c7 = $("<td>" + oracleDate(decision.dec_calc_due_dt) + "</td>");
		    //var c8 = $("<td><a>Receipts</a></td>");
		    //$(c8).find("a").attr("onclick","javascript: showDetail(this);");

		    //add cells to row detail pane DOM 
		    $(row).append(c1);$(row).append(c2);$(row).append(c3);$(row).append(c4);
		    $(row).append(c5);$(row).append(c6);$(row).append(c7); 
		    //$(row).append(c8);

		    $(tTbl).append(row);
		    $(tTbl).append(detailPane);

		    //Now, set up receipt rows and add to DOM
		    $.each( decision.items, function(index,item){
		    	var iRow = $("<tr><td>" + item.subt_desc + "</td><td>(" + item.pin_punch_dt2 + ")</td><td>S#: " + item.irec_seq + "</td><td> - <a>" + item.sm_fname + " " + item.sm_lname + "<a></td></tr>");
		    	$(detailPane).find(".receipt_table").append(iRow);
		    	var anchor = $(iRow).find('a'); 
		    	$(anchor).on('click',function(){
		    		contactDialog(anchor);
		    	});

		    });

	    }

  	});//end decision each loop

} 



function showDetail(row){

 var detailPane = $($(row).next()[0]).find('.detail_pane')[0];
 $(detailPane).toggle();

}

function oracleDate(date){
	//pass in date as Oracle formats it, return string mm/dd/yyyy

	var indexTime = date.indexOf("T");
	var justDate = date.substring(0,indexTime);
	var newString = justDate.split("-")[1] + "/" + justDate.split("-")[2] + "/" + justDate.split("-")[0]
	return newString

}

function contactDialog(anchor) {
	//this funtion handles the click event on a reviewer's name
	//it creates the dialog on the fly, fetches the results from the /people endpoint and populates it


	//1. create content div, then bind it to dialog
	var contactDiv = $("<div><div id='progressbar'></div><div>Loading...</div><table class='contact_table'><tr><td width='70px'>Name:</td><td 'class'='name1'></td></tr><tr><td>Phone:</td><td class='phone'></td></tr><tr><td>Mail Code:</td><td></td></tr><tr><td>Location:</td><td></td></tr><tr><td>Building:</td><td></td></tr><tr><td>Room:</td><td></td></tr></table></div>");
	$(contactDiv).dialog({"title":"Contact Information"});
	$(contactDiv).dialog("open");//2. open the dialog
	//2.5 start progress bar
	var progBar = $(contactDiv).find("#progressbar")[0];
	$(progBar).progressbar({value: false});
	var temp = 1;
	//3. fetch the person's contact information
	$.ajax({
	  type: "get",
	  url: api_url + ":3000/people/",
      crossDomain: true,
      data: {"first":"Reuben","last":"Baris"},
      beforeSend: function(xhr) {

      }
      ,
      success: function (data){
    	//4. update the contact table with lookup results
		$(progBar).progressbar("destroy");    	
		$(progBar).next().empty();
    	people_data = data[0];
    	var nameDiv = $(contactDiv).find("td")[1];
    	$(nameDiv).text(people_data.name);
    	
      }

	});	
}

